const DB_KEY='taiba_db_v2'
const SESSION_KEY='taiba_session_v2'
const months=['January','February','March','April','May','June','July','August','September','October','November','December']
const el=id=>document.getElementById(id)
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36)
const todayISO=()=>new Date().toISOString()
const toDate=iso=>new Date(iso)
const fmtMoney=n=>Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(Number(n||0))
const fmtDate=iso=>new Date(iso).toLocaleDateString()
function notify(message,type='info'){ const t=el('toast'); if(!t) return; t.textContent=message; if(type==='error'){ t.style.background='linear-gradient(135deg,rgba(255,107,107,.9),rgba(255,107,107,.6))'; t.style.color='#1b0f0f' } else if(type==='success'){ t.style.background='linear-gradient(135deg,rgba(34,197,94,.9),rgba(34,197,94,.6))'; t.style.color='#0e1a0f' } else { t.style.background='linear-gradient(135deg,rgba(79,209,197,.35),rgba(130,170,255,.35))'; t.style.color='#e6e9ef' } t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show') },2200) }
function showLoginRequired(){ const modal=document.getElementById('loginRequiredModal'); if(modal && window.bootstrap && typeof window.bootstrap.Modal==='function'){ const m=new window.bootstrap.Modal(modal); m.show() } else { notify('Please login to perform this action','error') } }
function guardActions(){ const guardSubmit=(id,requiresAdmin=false)=>{ const f=el(id); if(!f) return; f.addEventListener('submit',e=>{ const notAllowed=!session || (requiresAdmin && session.role!=='admin'); if(notAllowed){ e.preventDefault(); showLoginRequired() } },true) }; guardSubmit('createRequestForm',false); guardSubmit('addHouseholdForm',true); guardSubmit('generateBillsForm',true); document.addEventListener('click',e=>{ const btn=e.target.closest('button'); if(!btn) return; const act=btn.dataset.act; const id=btn.id; let requiresAdmin=false; let isAction=false; if(act){ isAction=true; requiresAdmin=['approve','reject','markPaid','usage','remove'].includes(act) } if(id==='clearAllRequestsBtn'||id==='exportBtn'||id==='importBtn'){ isAction=true; requiresAdmin=true } if(isAction){ const notAllowed=!session || (requiresAdmin && session.role!=='admin'); if(notAllowed){ e.preventDefault(); showLoginRequired() } } },true) }
function loadDB(){ const raw=localStorage.getItem(DB_KEY); if(raw){ try{ return JSON.parse(raw) }catch(e){ localStorage.removeItem(DB_KEY) } } const seed={ users:[{id:uid(),email:'admin@taiba.local',password:'admin123',role:'admin'},{id:uid(),email:'user@taiba.local',password:'user123',role:'user'}], households:[], bills:[], requests:[], settings:{pricePerM3:2} }; localStorage.setItem(DB_KEY,JSON.stringify(seed)); return seed }
function saveDB(db){ localStorage.setItem(DB_KEY,JSON.stringify(db)) }
function loadSession(){ const raw=localStorage.getItem(SESSION_KEY); return raw?JSON.parse(raw):null }
function saveSession(s){ localStorage.setItem(SESSION_KEY,JSON.stringify(s)) }
function clearSession(){ localStorage.removeItem(SESSION_KEY) }
let db=loadDB()
let session=loadSession()
function setUserArea(){ const ua=el('userArea'); if(!ua) return; if(session){ ua.innerHTML=`<span class="chip">${session.email} • ${session.role}</span>`; const lo=el('logoutBtn'); if(lo) lo.classList.remove('hidden') } else { ua.innerHTML=''; const lo=el('logoutBtn'); if(lo) lo.classList.add('hidden') } }
function setGuestAlert(){ const a=document.getElementById('guestAlert'); if(!a) return; if(session){ a.classList.add('d-none') } else { a.classList.remove('d-none') } }
function showLogin(){ const lv=el('login-view'); const mv=el('main-view'); if(lv) lv.classList.remove('hidden'); if(mv) mv.classList.add('hidden') }
function showMain(){ const lv=el('login-view'); const mv=el('main-view'); if(lv) lv.classList.add('hidden'); if(mv) mv.classList.remove('hidden'); const isAdmin=(session&&session.role==='admin'); document.querySelectorAll('.admin-only').forEach(x=>x.style.display=isAdmin?'inline-flex':'none') }
function setActiveTab(id){ document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.section===id)); document.querySelectorAll('.section').forEach(s=>s.classList.toggle('hidden',s.id!==id)) }
function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e).toLowerCase()) }
function passwordIssue(p){ const s=String(p||''); if(s.length<8) return 'Password must be at least 8 characters'; if(!/[a-zA-Z]/.test(s)||!/\d/.test(s)) return 'Password must include letters and numbers'; return null }
async function login(email,password){ if(!isValidEmail(email)){ notify('Enter a valid email','error'); return false } const u=db.users.find(x=>x.email.toLowerCase()===email.toLowerCase()&&x.password===password); if(!u){ notify('Invalid credentials','error'); return false } session={email:u.email,role:u.role}; saveSession(session); setUserArea(); const hasMain=!!el('main-view'); if(hasMain){ showMain(); setActiveTab('dashboard'); renderAll() } return true }
function logout(){ session=null; clearSession(); setUserArea(); showLogin() }
function renderStats(){ const activeHouseholds=db.households.filter(h=>h.status!=='disconnected'&&h.status!=='inactive').length; const pendingRequests=db.requests.filter(r=>r.status==='pending').length; const dueBills=db.bills.filter(b=>b.status==='due').length; const lateBills=db.bills.filter(b=>b.status==='late').length; el('statHouseholds').textContent=activeHouseholds; el('statPendingRequests').textContent=pendingRequests; el('statDueBills').textContent=dueBills; el('statLateBills').textContent=lateBills }
function highConsumption(){ const out=[]; const now=new Date(); const m=now.getMonth()+1; const y=now.getFullYear(); db.households.forEach(h=>{ const rec=(h.consumptionHistory||[]).find(c=>c.month===m&&c.year===y); const val=rec?Number(rec.m3||0):Number(h.currentUsage||0); if(val>=100) out.push({h,val}) }); out.sort((a,b)=>b.val-a.val); return out }
function renderHighConsumption(){ const list=highConsumption(); if(!list.length){ el('highConsumptionList').innerHTML='<div class="muted">No high consumption records this month</div>'; return } const rows=list.map(x=>`<tr><td>${x.h.ownerEmail||'-'}</td><td>${x.h.block}</td><td>${x.h.connectionType}</td><td>${Number(x.val||0).toFixed(2)} m³</td></tr>`).join(''); el('highConsumptionList').innerHTML=`<table><thead><tr><th>Owner</th><th>Block</th><th>Type</th><th>Consumption</th></tr></thead><tbody>${rows}</tbody></table>` }
function renderRequests(){ const canReview=(session&&session.role==='admin'); const isUser=(session&&session.role==='user'); const rows=db.requests.filter(r=> isUser? r.requesterEmail===session.email : true).map(r=>{ const payloadShort=JSON.stringify(r.payload||{}); const actions=canReview&&r.status==='pending'?`<button class="btn small" data-act="approve" data-id="${r.id}">Approve</button><button class="btn small danger" data-act="reject" data-id="${r.id}">Reject</button>`:''; return `<tr><td>${r.type.replace('_',' ')}</td><td>${r.requesterEmail||'-'}</td><td>${fmtDate(r.createdAt)}</td><td><span class="badge ${r.status}">${r.status}</span></td><td>${payloadShort}</td><td>${actions}</td></tr>` }).join(''); el('requestsList').innerHTML=`<table><thead><tr><th>Type</th><th>Requester</th><th>Date</th><th>Status</th><th>Details</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`; el('requestsList').querySelectorAll('button[data-id]').forEach(b=>{ b.addEventListener('click',e=>{ const id=e.currentTarget.dataset.id; const act=e.currentTarget.dataset.act; const r=db.requests.find(x=>x.id===id); if(!r) return; if(act==='approve') handleApproveRequest(r); if(act==='reject') handleRejectRequest(r) }) }) }
function handleApproveRequest(r){ r.status='approved'; r.resolvedAt=todayISO(); r.reviewerEmail=session.email; if(r.type==='new_connection'){ const p=r.payload||{}; const hh={id:uid(),ownerEmail:p.ownerEmail,block:p.block,connectionType:p.connectionType,status:'active',currentUsage:Number(p.initialUsage||0),consumptionHistory:[],createdAt:todayISO()}; db.households.push(hh) } if(r.type==='usage_adjustment'){ const p=r.payload||{}; const h=db.households.find(x=>x.id===p.householdId); if(h){ const m=Number(p.month); const y=Number(p.year); const val=Number(p.newUsage||0); if(!h.consumptionHistory) h.consumptionHistory=[]; const rec=h.consumptionHistory.find(x=>x.month===m&&x.year===y); if(rec) rec.m3=val; else h.consumptionHistory.push({month:m,year:y,m3:val}); h.currentUsage=val } } if(r.type==='disconnection'){ const p=r.payload||{}; const h=db.households.find(x=>x.id===p.householdId); if(h) h.status='disconnected' } if(r.type==='access'){ const p=r.payload||{}; const exists=db.users.find(x=>x.email.toLowerCase()===String(p.email||'').toLowerCase()); if(!exists){ db.users.push({id:uid(),email:p.email,password:'changeme',role:'user'}) } } saveDB(db); renderAll() }
function handleRejectRequest(r){ r.status='rejected'; r.resolvedAt=todayISO(); r.reviewerEmail=session.email; saveDB(db); renderAll() }
function renderHouseholds(){ const fb=(el('filterBlock').value||'').trim().toLowerCase(); const ft=el('filterType').value; const rows=db.households.filter(h=>{ const bOk=fb?(String(h.block||'').toLowerCase().includes(fb)):true; const tOk=ft? h.connectionType===ft : true; return bOk&&tOk }).map(h=>{ const actions=(session&&session.role==='admin')?`<button class="btn small" data-h="${h.id}" data-act="usage">Update Usage</button><button class="btn small" data-h="${h.id}" data-act="remove">Remove</button>`:''; const ch=(h.consumptionHistory||[]).slice(-3).map(c=>`${months[c.month-1]} ${c.year}: ${Number(c.m3||0).toFixed(2)} m³`).join('<br>'); return `<tr><td>${h.ownerEmail||'-'}</td><td>${h.block}</td><td>${h.connectionType}</td><td>${h.status}</td><td>${Number(h.currentUsage||0).toFixed(2)} m³</td><td>${ch||'-'}</td><td>${actions}</td></tr>` }).join(''); el('householdsList').innerHTML=`<table><thead><tr><th>Owner</th><th>Block</th><th>Type</th><th>Status</th><th>Usage</th><th>History</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`; el('householdsList').querySelectorAll('button[data-h]').forEach(b=>{ b.addEventListener('click',e=>{ const act=e.currentTarget.dataset.act; const id=e.currentTarget.dataset.h; const h=db.households.find(x=>x.id===id); if(!h) return; if(act==='usage'){ const m=prompt('Month number (1-12)',String(new Date().getMonth()+1)); const y=prompt('Year',String(new Date().getFullYear())); const v=prompt('New usage m³',String(h.currentUsage||0)); const mm=Number(m),yy=Number(y),vv=Number(v||0); if(mm>=1&&mm<=12&&yy>2000){ if(!h.consumptionHistory) h.consumptionHistory=[]; const rec=h.consumptionHistory.find(x=>x.month===mm&&x.year===yy); if(rec) rec.m3=vv; else h.consumptionHistory.push({month:mm,year:yy,m3:vv}); h.currentUsage=vv; saveDB(db); renderHouseholds() } } if(act==='remove'){ h.status='inactive'; saveDB(db); renderHouseholds() } }) }) }
function renderMonths(){ const sel=el('billMonth'); sel.innerHTML=months.map((m,i)=>`<option value="${i+1}">${m}</option>`).join(''); el('billYear').value=new Date().getFullYear(); el('pricePerM3').value=db.settings.pricePerM3 }
function generateBills(month,year,price){ db.households.filter(h=>h.status==='active').forEach(h=>{ const rec=(h.consumptionHistory||[]).find(c=>c.month===month&&c.year===year); const usage=rec?Number(rec.m3||0):Number(h.currentUsage||0); const amount=Number(usage)*Number(price); const dueDate=new Date(year,month,0); dueDate.setDate(dueDate.getDate()+15); const b={id:uid(),householdId:h.id,ownerEmail:h.ownerEmail,month,year,amount,status:'due',dueDate:dueDate.toISOString(),createdAt:todayISO()}; const exists=db.bills.find(x=>x.householdId===h.id&&x.month===month&&x.year===year); if(!exists) db.bills.push(b) }); db.settings.pricePerM3=Number(price); saveDB(db) }
function refreshBillStatuses(){ const now=new Date(); db.bills.forEach(b=>{ if(b.status!=='paid'){ const dd=new Date(b.dueDate); b.status=dd<now?'late':'due' } }); saveDB(db) }
function renderBills(){ refreshBillStatuses(); const f=el('filterBillStatus').value; const rows=db.bills.filter(b=> f? b.status===f : true).sort((a,b)=> toDate(b.createdAt)-toDate(a.createdAt)).map(b=>{ const actions=b.status!=='paid'&&(session&&session.role==='admin')?`<button class="btn small" data-b="${b.id}" data-act="markPaid">Mark Paid</button>`:''; return `<tr><td>${b.ownerEmail||'-'}</td><td>${months[b.month-1]} ${b.year}</td><td>${fmtMoney(b.amount)}</td><td><span class="badge ${b.status}">${b.status}</span></td><td>${fmtDate(b.dueDate)}</td><td>${actions}</td></tr>` }).join(''); el('billsList').innerHTML=`<table><thead><tr><th>Owner</th><th>Period</th><th>Amount</th><th>Status</th><th>Due</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`; el('billsList').querySelectorAll('button[data-b]').forEach(b=>{ b.addEventListener('click',e=>{ const id=e.currentTarget.dataset.b; const bill=db.bills.find(x=>x.id===id); if(!bill) return; bill.status='paid'; saveDB(db); renderBills(); renderStats() }) }) }
function renderNotifications(){ refreshBillStatuses(); const items=db.bills.filter(b=> b.status==='due'||b.status==='late').map(b=>{ const t=b.status==='late'?'Late payment':'Upcoming due'; return `<tr><td>${t}</td><td>${b.ownerEmail||'-'}</td><td>${months[b.month-1]} ${b.year}</td><td>${fmtMoney(b.amount)}</td><td>${fmtDate(b.dueDate)}</td><td><span class="badge ${b.status}">${b.status}</span></td></tr>` }); el('notificationsList').innerHTML=items.length?`<table><thead><tr><th>Type</th><th>Owner</th><th>Period</th><th>Amount</th><th>Due</th><th>Status</th></tr></thead><tbody>${items.join('')}</tbody></table>`:'<div class="muted">No notifications</div>' }
function renderUsers(){ const rows=db.users.map(u=>`<tr><td>${u.email}</td><td>${u.role}</td><td>${u.password}</td></tr>`).join(''); el('usersList').innerHTML=`<table><thead><tr><th>Email</th><th>Role</th><th>Temp Password</th></tr></thead><tbody>${rows}</tbody></table>` }
function renderAll(){ renderStats(); renderHighConsumption(); renderRequests(); renderHouseholds(); renderBills(); renderNotifications(); renderUsers() }
function buildRequestFields(){ const type=el('requestType').value; const c=el('requestFields'); if(type==='new_connection'){ c.innerHTML=`<label>Owner Email<input type="email" id="reqOwnerEmail" required /></label><label>Block<input type="text" id="reqBlock" required /></label><label>Connection Type<select id="reqConnectionType"><option>Metered</option><option>Flat</option><option>Shared</option></select></label><label>Initial Usage (m³)<input type="number" id="reqInitialUsage" min="0" step="0.01" value="0" /></label>` } else if(type==='usage_adjustment'){ c.innerHTML=`<label>Household ID<input type="text" id="reqHouseholdId" required /></label><label>Month<select id="reqMonth">${months.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('')}</select></label><label>Year<input type="number" id="reqYear" value="${new Date().getFullYear()}" /></label><label>New Usage (m³)<input type="number" id="reqNewUsage" min="0" step="0.01" /></label>` } else if(type==='disconnection'){ c.innerHTML=`<label>Household ID<input type="text" id="reqHouseholdId2" required /></label>` } else if(type==='access'){ c.innerHTML=`<label>Email<input type="email" id="accessEmail" required /></label><label>Reason<textarea id="accessReason" rows="3"></textarea></label>` } else { c.innerHTML='' } }
function mountEvents(){ const lf=el('loginForm'); if(lf) lf.addEventListener('submit',async e=>{ e.preventDefault(); const email=el('loginEmail').value.trim(); const password=el('loginPassword').value.trim(); await login(email,password) }); const lb=el('loginBtn'); if(lb) lb.addEventListener('click',async e=>{ e.preventDefault(); const email=el('loginEmail').value.trim(); const password=el('loginPassword').value.trim(); await login(email,password) }); const rf=el('registerForm'); if(rf) rf.addEventListener('submit',e=>{ e.preventDefault(); const email=(el('regEmail').value||'').trim(); const pass=el('regPassword').value||''; const confirm=el('regConfirm').value||''; if(!isValidEmail(email)){ notify('Enter a valid email','error'); return } const issue=passwordIssue(pass); if(issue){ notify(issue,'error'); return } if(pass!==confirm){ notify('Passwords do not match','error'); return } const exists=db.users.find(x=>x.email.toLowerCase()===email.toLowerCase()); if(exists){ notify('Email already registered','error'); return } db.users.push({id:uid(),email,password:pass,role:'user'}); saveDB(db); notify('Account created. Logging you in...','success'); setTimeout(()=>{ login(email,pass) },600) }); const logoutBtn=el('logoutBtn'); if(logoutBtn) logoutBtn.addEventListener('click',()=>logout()); document.querySelectorAll('#tabs .tab').forEach(b=>{ b.addEventListener('click',()=>{ setActiveTab(b.dataset.section) }) }); const createReqForm=el('createRequestForm'); if(createReqForm) createReqForm.addEventListener('submit',e=>{ e.preventDefault(); const type=el('requestType').value; const requester=(session&&session.email)?session.email:'guest'; let payload={}; if(type==='new_connection'){ payload={ownerEmail:el('reqOwnerEmail').value.trim(),block:el('reqBlock').value.trim(),connectionType:el('reqConnectionType').value,initialUsage:Number(el('reqInitialUsage').value||0)} } if(type==='usage_adjustment'){ payload={householdId:el('reqHouseholdId').value,month:Number(el('reqMonth').value),year:Number(el('reqYear').value),newUsage:Number(el('reqNewUsage').value||0)} } if(type==='disconnection'){ payload={householdId:el('reqHouseholdId2').value} } if(type==='access'){ const email=(el('accessEmail')&&el('accessEmail').value||'').trim(); const reason=(el('accessReason')&&el('accessReason').value||'').trim(); payload={email,reason} } const r={id:uid(),type,payload,requesterEmail:requester,status:'pending',createdAt:todayISO()}; db.requests.push(r); saveDB(db); renderRequests(); notify('Request submitted','success') }); const rt=el('requestType'); if(rt){ rt.addEventListener('change',buildRequestFields); buildRequestFields() } const addHouseholdForm=el('addHouseholdForm'); if(addHouseholdForm) addHouseholdForm.addEventListener('submit',e=>{ e.preventDefault(); const h={id:uid(),ownerEmail:el('hhOwnerEmail').value.trim(),block:el('hhBlock').value.trim(),connectionType:el('hhConnectionType').value,status:'active',currentUsage:Number(el('hhInitialUsage').value||0),consumptionHistory:[],createdAt:todayISO()}; db.households.push(h); saveDB(db); renderHouseholds(); addHouseholdForm.reset(); notify('Household added','success') }); const fb=el('filterBlock'); if(fb) fb.addEventListener('input',renderHouseholds); const ft=el('filterType'); if(ft) ft.addEventListener('change',renderHouseholds); const gen=el('generateBillsForm'); if(gen) gen.addEventListener('submit',e=>{ e.preventDefault(); const m=Number(el('billMonth').value); const y=Number(el('billYear').value); const p=Number(el('pricePerM3').value); generateBills(m,y,p); renderBills(); renderStats(); notify('Bills generated','success') }); const fbs=el('filterBillStatus'); if(fbs) fbs.addEventListener('change',renderBills); const clearBtn=el('clearAllRequestsBtn'); if(clearBtn) clearBtn.addEventListener('click',()=>{ if(!(session&&session.role==='admin')) return; if(confirm('Clear all requests?')){ db.requests=[]; saveDB(db); renderRequests(); renderStats() } }); const exportBtn=el('exportBtn'); if(exportBtn) exportBtn.addEventListener('click',()=>{ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(db,null,2)); a.download='taiba-export.json'; a.click() }); const importBtn=el('importBtn'); if(importBtn) importBtn.addEventListener('click',()=>{ const f=el('importFile').files[0]; if(!f){ alert('Select a JSON file'); return } const reader=new FileReader(); reader.onload=()=>{ try{ const j=JSON.parse(reader.result); if(j&&j.users&&j.households&&j.bills&&j.requests&&j.settings){ db=j; saveDB(db); renderAll(); alert('Data imported') } else { alert('Invalid JSON structure') } }catch(e){ alert('Invalid JSON') } }; reader.readAsText(f) }); window.addEventListener('hashchange', ()=>{ const hash=(window.location.hash||'').toLowerCase(); if(hash==='#login'||hash==='#register'){ showLogin() } else { showMain() } });
}
function boot(){ setUserArea(); setGuestAlert(); renderMonths(); mountEvents(); const hash=(window.location.hash||'').toLowerCase(); if(hash==='#login'||hash==='#register'){ showLogin() } else { showMain() } renderAll() }
if(document.readyState==='complete'||document.readyState==='interactive'){ boot(); guardActions() } else { window.addEventListener('DOMContentLoaded', ()=>{ boot(); guardActions() }) }
